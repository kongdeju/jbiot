#!/usr/bin/env python
#coding=utf-8
import sys
reload(sys)
sys.setdefaultencoding("utf-8")
import os
dirpath = os.path.join(os.path.dirname(os.path.abspath(__file__)),"../")
sys.path.insert(0,dirpath)
from jbiot import lsub
import glob
jbio = os.path.join(os.path.dirname(os.path.abspath(__file__)),"jbio.send")
jmail = os.path.join(os.path.dirname(os.path.abspath(__file__)),"jmail")
cmd2showdoc = os.path.join(os.path.dirname(os.path.abspath(__file__)),"cmd2showdoc.py")
import time
import yaml
import getpass
from jbiot.subjobs.lsub_log import readlog
from jbiot.subjobs.jbmsg import *

def readwechat():
    home = os.environ["HOME"]
    cfg = os.path.join(home,".lcsub","config.yml")
    if not os.path.exists(cfg):
        return

    fp = open(cfg)
    cfg = yaml.load(fp.read())
    if not cfg:
        return
    if "wechat" in cfg:
        return cfg["wechat"]

def setwechat(wechat):
    home = os.environ["HOME"]
    cfg = os.path.join(home,".lcsub","config.yml")
    cfgdir = os.path.join(home,".lcsub")
    if not os.path.exists(cfgdir):
        os.mkdir(cfgdir)
    if os.path.exists(cfg):
        infodict = yaml.load(open(cfg).read())
    if not infodict:
        infodict = {}
    infodict["wechat"]  = wechat

    fp = open(cfg,"w")
    outstr = yaml.dump(infodict,default_flow_style=False)
    fp.write(outstr)


if __name__ == "__main__":

    from docopt import docopt

    usage = """
    Usage:
        lsub [options] <cmdfile> 

    Options:
        -h --help                print this screen
        --dry                    all done but run script
        --rerun                  rerun the job from last failure point
        --force                  force run even error detected
        --verbose                verbose mode lot of information will print
        --with-docker            prefer to use docker when run cmd
        --with-singularity       prefer to user singularity when run cmd
        -e,--email=<email>       email of you want to remind of
        -w,--wechat=<name>       wechat name you want to send to
        -n,--name=<job_name>     the name of this task.
    """
    args = docopt(usage)
    cmdfile = args["<cmdfile>"]
    dryflag = args["--dry"]
    docker = args["--with-docker"]
    sing = args["--with-singularity"]
    email = args["--email"]
    wechat = args["--wechat"]
    name = args["--name"]
    verbose = args["--verbose"]
    force = args["--force"]
    rerun = args["--rerun"]
    lsub.main(cmdfile,dryflag,docker=docker,sing=sing,rerun=rerun,verbose=verbose,force=force)
    
    content = readlog(cmdfile)
    # try wechat to user
    #if wechat:
    #    setwechat(wechat)
    #wechat = readwechat()
    #if wechat:
    #    cmd = "%s '%s' -u '%s' " % (jbio,msg,wechat)
    #    os.system(cmd)
    # email to user
    if email :
        setemail(email)
    email = reademail()
    if email:
        subject = "lsub run finished report"
        if name:
            subject = name
        cmd = "%s -t %s -s '%s' -c '%s'" % (jmail,email,subject,content)
        os.system(cmd)
    # upload to showdoc
    if name:
        cmd = "%s %s -t %s" % (cmd2showdoc,cmdfile,name)
        os.system(cmd)

